---
title: "Spaghetti tube - Partner Payoffs Highpassing (aka Phase 7)"
author: "Christoph Voelter"
date: "August 02, 2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library (car)
library(lme4)
library(readr)
library(tidyverse)
library(sjPlot)
library(ggthemes)
library(ggplot2)
library(scales)
library(gridExtra)
library(psych)
library(summarytools)
source("../../R scripts/Roger/diagnostic_fcns.r")
source("../../R scripts/Roger/glmm_stability.r")
source("../../R scripts/Roger/boxplotteR.r")
source("../../R scripts/Roger/boot_glmm.r")
source("../../R scripts/Roger/corr_exact.r")
load(file ="exp2_GLMM_S02_HighPassing.rData")
#readRDS(file ="multpos_model.rds")
```

```{r loading data, include = FALSE, warning = FALSE}
#Preparing code for mixed modeling. 
all.data <- read.table(file="data/Spaghetti_Tube_Phase7_data_for_r.txt", header=T, sep="\t")
str(all.data)
describeBy(all.data)

all.data=subset(all.data, tool_trans==1)
all.data<-all.data %>%
  mutate(BeggingGestures = na_if(BeggingGestures, "?")) %>%
  mutate(AttgetObeg = na_if(AttgetObeg, "?")) %>%
  mutate(Gesture = ifelse(BeggingGestures=="yes","yes",(ifelse(AttgetObeg=="yes","yes","no"))))

  
all.data<-droplevels(all.data)
all.data$Gesture=as.factor(all.data$Gesture)
view(dfSummary(all.data))

```




```{r error=FALSE, echo=FALSE}
#Tool recipient: spaghetti tube
plot_individual2 <- all.data %>%
  mutate(dir_dyad = paste(Room3, Room4, sep = '_'))%>%
  group_by(Species, dir_dyad) %>% 
  summarize(Highpass2 = mean(Highpass))  %>%
  mutate(Highpass2 = round(Highpass2/0.01)*0.01)%>%
  add_count(Highpass2)

median_highpass<-plot_individual2  %>%
  group_by(Species) %>% 
  summarize(Highpass.m = median(Highpass2))  


p1 <- ggplot(
  data=plot_individual2, aes(Species, Highpass2, group=dir_dyad)) +   
  geom_boxplot(aes(group=Species), width=0.9, outlier.colour="white")+
  geom_point(size = plot_individual2$n, colour = "darkgrey", alpha=0.4) +
  geom_line(lty=2, alpha=0.4)+
  ylim(0,1)+
  labs(x="Species",y="High tool passing")+
  theme_few()+
  theme(axis.ticks.x=element_blank(), axis.title.x = element_text(size=10), plot.title = element_text(size=12), plot.caption = element_text(size=10))#+     # ggtitle("Tool giver: Non-social Payoff")

#tiff("SpaghettiTube_tool_transfer_predictors.tiff", width= 180, height= 120, units = "mm", res=150)
#grid.arrange(p1, p2,p3, nrow = 1, heights=unit(100, "mm"))
#dev.off()
p1
#ggsave("SpaghettiTube_highpass.png", width = 9, height = 7, units = "cm")


```

```







#GLMM with gesture

```{r eval=FALSE, echo=FALSE}
xx.fe.re=fe.re.tab(fe.model="Highpass ~ SpaghettiTube*NonsocialRoom4+ Species+ Session+Trial+Presence+Gesture ",
                   re="(1|Room3)+ (1|Room4)+ (1|Dyad)", data=all.data)
xx.fe.re$summary
```



``` {r mixed modeling, error=TRUE}

# centering variables for modeling

model.data <- all.data %>% 
  na.omit(cols=Gesture)%>% 
  mutate(z.Trial = scale(Trial, scale = T, center = T),
         z.Session = scale(Session, scale=T, center=T),
         BeggingGestures = relevel(BeggingGestures, ref = "yes"),
         AttgetObeg = relevel(AttgetObeg, ref = "yes"),
         NonsocialRoom3.c = scale(as.numeric(NonsocialRoom3), scale=F,center=T),
         SpaghettiTube.c = scale(as.numeric(SpaghettiTube), scale=F,center=T),
         NonsocialRoom4.c = scale(as.numeric(NonsocialRoom4), scale=F,center=T),
         Gesture.c = as.numeric(Gesture)-mean(as.numeric(Gesture)),
         Presence.c = scale(as.numeric(Presence), scale=F,center=T))

```





``` {r mixed modeling, error=TRUE}


## code to run the model
mm.S2 <- glmer(Highpass~SpaghettiTube+NonsocialRoom4  + Species+ z.Session+z.Trial+
             (1|Room3)+(1|Room4)+ (1|Dyad)+
             
             (0+z.Session|Room3)+ 
             (0+z.Session|Room4)+
             (0+z.Session|Dyad)+
  
             (0+z.Trial|Room3)+ 
             (0+z.Trial|Room4)+
             (0+z.Trial|Dyad)+

             (0+SpaghettiTube.c|Room3)+ 
             (0+SpaghettiTube.c|Room4)+
             (0+SpaghettiTube.c|Dyad)+
             
             (0+NonsocialRoom4.c|Room3)+ 
             (0+NonsocialRoom4.c|Room4)+
             (0+NonsocialRoom4.c|Dyad)

             , data = model.data
             , family = binomial
             , control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))
)
```



``` {r mixed modeling, error=TRUE}


## code to run the model
mm.S2.null <- glmer(Highpass~1+ z.Session+z.Trial+
             (1|Room3)+(1|Room4)+ (1|Dyad)+
             
             (0+z.Session|Room3)+ 
             (0+z.Session|Room4)+
             (0+z.Session|Dyad)+
  
             (0+z.Trial|Room3)+ 
             (0+z.Trial|Room4)+
             (0+z.Trial|Dyad)+

             (0+SpaghettiTube.c|Room3)+ 
             (0+SpaghettiTube.c|Room4)+
             (0+SpaghettiTube.c|Dyad)+
             
             (0+NonsocialRoom4.c|Room3)+ 
             (0+NonsocialRoom4.c|Room4)+
             (0+NonsocialRoom4.c|Dyad)

             , data = model.data
             , family = binomial
             , control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))
)
```



####Full-null model comparison
```{r}	 
anova(mm.S2, mm.S2.null, test="Chisq")
```


####Model output
  + Coefficients
```{r}
round(summary(mm.S2)$coefficients, 3)
```
 
mean and SE of the covariates: 
```{r}
mean(model.data$Session)
sd(model.data$Session)

mean(model.data$Trial)
sd(model.data$Trial)

``` 




  + Individual predictors: likelihood ratio tests  
Drop1: P values for the individual effects were based on likelihood ratio tests comparing the full with respective reduced models (Barr et al., 2013; R function drop1 with argument 'test' set to "Chisq"). 
```{r}
xdrop.mm.S2=drop1(mm.S2, test="Chisq")
round(xdrop.mm.S2,6)
```


#### check for colinearity in the previous model.

```{R echo=FALSE, error=FALSE, warning=FALSE}

col.mm <- glm(Highpass~SpaghettiTube+NonsocialRoom4  + Species+ z.Session+z.Trial
              , data = model.data
             
)
vif(col.mm)
#no problem
```




##Model for plot


``` {r mixed modeling, error=TRUE}


## code to run the model
pred.mm.S2 <- glmer(Highpass~SpaghettiTube.c+NonsocialRoom4.c  + Species+ z.Session+z.Trial+
             (1|Room3)+(1|Room4)+ (1|Dyad)+
             
             (0+z.Session|Room3)+ 
             (0+z.Session|Room4)+
             (0+z.Session|Dyad)+
  
             (0+z.Trial|Room3)+ 
             (0+z.Trial|Room4)+
             (0+z.Trial|Dyad)+

             (0+SpaghettiTube.c|Room3)+ 
             (0+SpaghettiTube.c|Room4)+
             (0+SpaghettiTube.c|Dyad)+
             
             (0+NonsocialRoom4.c|Room3)+ 
             (0+NonsocialRoom4.c|Room4)+
             (0+NonsocialRoom4.c|Dyad)

             , data = model.data
             , family = binomial
             , control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))
)
```

```{r}
save.image("exp2_GLMM_S02_HighPassing.rData")

```
